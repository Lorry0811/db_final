# BookSwap 假資料批量生成說明

本文檔說明如何在 BookSwap 資料庫中批量產生假資料，用於測試和演示。

---

## 📋 目錄

1. [概述](#概述)
2. [前置準備](#前置準備)
3. [生成方式](#生成方式)
4. [各表假資料說明](#各表假資料說明)
5. [執行步驟](#執行步驟)
6. [注意事項](#注意事項)
7. [資料統計](#資料統計)

---

## 概述

BookSwap 資料庫包含 13 個主要資料表，假資料生成腳本會按照以下順序生成資料：

1. **基礎資料表**（需先建立）：
   - `department`（科系）
   - `class`（分類）
   - `course`（課程）

2. **使用者相關表**：
   - `user`（使用者）

3. **商品相關表**：
   - `posting`（刊登）
   - `posting_images`（刊登圖片）

4. **互動相關表**：
   - `comment`（留言）
   - `favorite_posts`（收藏）

5. **交易相關表**：
   - `orders`（訂單）
   - `transaction_record`（交易紀錄）
   - `review`（評價）

6. **通訊相關表**：
   - `message`（私訊）

7. **管理相關表**：
   - `report`（舉報）

---

## 前置準備

### 1. 確認資料庫結構

在生成假資料之前，請確認：
- 所有資料表已建立（執行 `001_initial_schema.sql`）
- 所有遷移腳本已執行（`002_add_indexes.sql` 至 `007_fix_report_p_id_nullable.sql`）
- 資料庫連線正常

### 2. 清理現有資料（可選）

如果需要重新生成假資料，可以先執行清理腳本：

```sql
-- 執行清理腳本（會刪除所有資料，包括管理員帳號）
\i supabase/cleanup.sql

-- 或執行安全清理腳本（保留管理員帳號、科系、分類、課程）
\i supabase/cleanup_safe.sql
```

---

## 生成方式

### 方式一：使用完整腳本（推薦）

使用 `supabase/generate_fake_data.sql` 腳本，該腳本包含所有表的假資料生成語法：

```bash
# 在 Supabase SQL Editor 中執行
# 或使用 psql 命令列工具
psql -h <host> -U <user> -d <database> -f supabase/generate_fake_data.sql
```

### 方式二：使用現有 seed.sql

使用 `supabase/seed.sql` 腳本（已包含完整邏輯）：

```bash
psql -h <host> -U <user> -d <database> -f supabase/seed.sql
```

### 方式三：手動執行單個表的生成語法

從 `supabase/generate_fake_data.sql` 中複製特定表的生成語法，在 SQL Editor 中執行。

---

## 各表假資料說明

### 1. Department（科系）

**生成方式**：直接插入真實科系名稱

**數量**：20 個科系

**包含**：資訊管理、資訊工程、電機工程、機械工程、法律、經濟、企業管理、會計、財務金融、外國語文、中國文學、歷史、哲學、數學、物理、化學、生命科學、心理、社會、政治等

**特點**：
- 使用 `ON CONFLICT DO NOTHING` 避免重複插入
- 科系名稱唯一

### 2. Class（分類）

**生成方式**：直接插入分類名稱和描述

**數量**：8 個分類

**包含**：教科書、3C產品、生活用品、服飾、運動用品、書籍、家具、其他

**特點**：
- 使用 `ON CONFLICT DO NOTHING` 避免重複插入
- 分類名稱唯一

### 3. Course（課程）

**生成方式**：插入課程代碼、課程名稱，關聯到科系和分類

**數量**：20 個課程

**包含**：資料庫管理、系統分析與設計、程式設計、資料結構、演算法、電路學、電子學、民法總則、經濟學原理、管理學等

**特點**：
- 課程代碼和課程名稱組合唯一
- 自動關聯到對應的科系
- 預設分類為「教科書」

### 4. User（使用者）

**生成方式**：使用 PL/pgSQL 迴圈批量生成

**數量**：可調整（預設 1000 個）

**生成內容**：
- 電子郵件：`user1@example.com`, `user2@example.com`, ...
- 使用者名稱：`user1`, `user2`, ...
- 密碼雜湊：模擬 bcrypt hash（實際使用時需使用真實 hash）
- 餘額：隨機 0-10000
- 管理員：第一個使用者預設為管理員
- 封鎖狀態：預設為 FALSE

**調整方式**：
修改 `FOR i IN 1..1000 LOOP` 中的數字來改變生成數量

### 5. Posting（刊登）

**生成方式**：使用 PL/pgSQL 迴圈批量生成

**數量**：可調整（預設 12000 筆）

**生成內容**：
- 標題：根據分類生成不同標題
  - 教科書：`二手教科書 - [課程名稱] [編號]`
  - 3C產品：`二手[iPhone/MacBook/iPad/筆電/手機] [編號]`
  - 其他：`二手物品 [編號]`
- 描述：`這是商品描述 [編號]。商品狀況良好，歡迎詢問。`
- 價格：根據分類設定不同價格範圍
  - 教科書：100-900
  - 3C產品：1000-21000
  - 其他：50-1050
- 狀態：隨機分配（60% listed, 20% sold, 10% reserved, 10% removed）
- 分類：隨機選擇
- 課程：如果是教科書分類，隨機選擇課程
- 建立時間：隨機過去 365 天內

**調整方式**：
- 修改 `FOR i IN 1..12000 LOOP` 中的數字來改變生成數量
- 修改狀態分配比例
- 修改價格範圍

### 6. Posting Images（刊登圖片）

**生成方式**：為每個刊登生成 1-3 張圖片

**數量**：每個刊登 1-3 張（隨機）

**生成內容**：
- 圖片 URL：使用 placeholder 圖片服務（`https://picsum.photos/800/600?random=...`）
- 顯示順序：從 0 開始遞增

**注意事項**：
- 實際使用時應替換為真實圖片 URL
- 或使用 Supabase Storage 上傳圖片後使用真實 URL

### 7. Comment（留言）

**生成方式**：使用 PL/pgSQL 迴圈批量生成

**數量**：可調整（預設 5000 筆）

**生成內容**：
- 留言內容：從預設陣列中隨機選擇
  - `'有興趣'`, `'想要'`, `'請問還有嗎？'`, `'可以議價嗎？'`, `'方便面交嗎？'`
- 刊登：隨機選擇現有刊登
- 留言者：隨機選擇現有使用者
- 建立時間：隨機過去 180 天內

**調整方式**：
- 修改 `FOR i IN 1..5000 LOOP` 中的數字
- 修改留言內容陣列

### 8. Favorite Posts（收藏）

**生成方式**：使用 PL/pgSQL 迴圈批量生成

**數量**：可調整（預設 8000 筆）

**生成內容**：
- 只收藏狀態為 `listed` 的刊登
- 使用者：隨機選擇現有使用者
- 刊登：隨機選擇現有刊登（僅 `listed` 狀態）
- 收藏時間：隨機過去 90 天內

**特點**：
- 使用 `ON CONFLICT DO NOTHING` 避免重複收藏
- 複合主鍵 (u_id, p_id) 確保唯一性

### 9. Orders（訂單）

**生成方式**：使用 PL/pgSQL 迴圈批量生成

**數量**：可調整（預設 3000 筆）

**生成內容**：
- 只選擇狀態為 `sold` 的刊登
- 買家：隨機選擇（不能是賣家）
- 賣家：從刊登的 `u_id` 取得
- 成交價格：使用刊登的原始價格
- 狀態：預設為 `completed`
- 訂單日期：隨機過去 200 天內

**特點**：
- 確保買家和賣家不是同一人
- 成交價格與刊登價格一致

### 10. Transaction Record（交易紀錄）

**生成方式**：使用 PL/pgSQL 迴圈批量生成

**數量**：可調整（預設 5000 筆）

**生成內容**：
- 交易類型：隨機選擇
  - `top_up`（儲值）：金額 100-5100（正數）
  - `payment`（付款）：金額 -100 至 -2100（負數）
  - `income`（收入）：金額 100-2100（正數）
  - `refund`（退款）：金額 10-510（正數）
- 使用者：隨機選擇現有使用者
- 交易時間：隨機過去 300 天內

**調整方式**：
- 修改 `FOR i IN 1..5000 LOOP` 中的數字
- 修改交易類型分配
- 修改金額範圍

### 11. Review（評價）

**生成方式**：使用 PL/pgSQL 迴圈批量生成

**數量**：可調整（預設 2000 筆）

**生成內容**：
- 只選擇狀態為 `completed` 的訂單
- 評價者：訂單的買家
- 被評價者：訂單對應刊登的賣家
- 評分：隨機 1-5 顆星
- 評價內容：從預設陣列中隨機選擇
  - `'商品狀況良好，賣家很友善'`
  - `'交易順利，推薦'`
  - `'還不錯'`
  - `'可以更好'`
  - `'普通'`
- 建立時間：隨機過去 150 天內

**特點**：
- 確保每個訂單只能評價一次（使用 `ON CONFLICT DO NOTHING`）
- 評價者必須是買家，被評價者必須是賣家

### 12. Message（私訊）

**生成方式**：使用 PL/pgSQL 迴圈批量生成

**數量**：可調整（預設 3000 筆）

**生成內容**：
- 發送者：隨機選擇現有使用者
- 接收者：隨機選擇不同的使用者（不能是自己）
- 訊息內容：從預設陣列中隨機選擇
  - `'你好'`, `'請問商品還在嗎？'`, `'可以議價嗎？'`, `'方便面交嗎？'`, `'謝謝'`
- 已讀狀態：70% 機率為已讀
- 發送時間：隨機過去 60 天內

**特點**：
- 確保發送者和接收者不是同一人（CHECK 約束）

### 13. Report（舉報）

**生成方式**：使用 PL/pgSQL 迴圈批量生成

**數量**：可調整（預設 200 筆）

**生成內容**：
- 舉報類型：目前只生成 `posting` 類型（刊登舉報）
- 舉報者：隨機選擇現有使用者
- 被舉報刊登：隨機選擇現有刊登
- 舉報原因：從預設陣列中隨機選擇
  - `'疑似詐騙'`, `'違禁品'`, `'不當內容'`, `'重複刊登'`, `'價格異常'`
- 舉報狀態：隨機選擇（pending, approved, rejected）
- 建立時間：隨機過去 30 天內

**注意事項**：
- 目前腳本只生成 `posting` 類型的舉報
- 如需生成 `comment` 或 `order_violation` 類型的舉報，需要修改腳本邏輯

---

## 執行步驟

### 步驟 1：準備資料庫

1. 確認 Supabase 專案已建立
2. 確認所有遷移腳本已執行
3. 確認資料庫連線正常

### 步驟 2：選擇生成方式

**選項 A：使用完整腳本（推薦）**
```sql
-- 在 Supabase SQL Editor 中執行
\i supabase/generate_fake_data.sql
```

**選項 B：使用現有 seed.sql**
```sql
-- 在 Supabase SQL Editor 中執行
\i supabase/seed.sql
```

**選項 C：手動執行單個表**
從 `generate_fake_data.sql` 中複製特定表的生成語法執行

### 步驟 3：調整參數（可選）

在執行前，可以修改 `generate_fake_data.sql` 中的參數：
- 使用者數量：修改 `FOR i IN 1..1000 LOOP` 中的數字
- 刊登數量：修改 `FOR i IN 1..12000 LOOP` 中的數字
- 其他表的數量：修改對應的迴圈範圍

### 步驟 4：執行腳本

1. 開啟 Supabase Dashboard
2. 進入 SQL Editor
3. 複製 `generate_fake_data.sql` 的內容
4. 貼上並執行
5. 等待執行完成（可能需要幾分鐘）

### 步驟 5：驗證資料

執行腳本最後的統計查詢，確認各表的資料數量：

```sql
SELECT 'Department' AS table_name, COUNT(*) AS count FROM department
UNION ALL
SELECT 'Class', COUNT(*) FROM class
UNION ALL
SELECT 'Course', COUNT(*) FROM course
UNION ALL
SELECT 'User', COUNT(*) FROM "user"
UNION ALL
SELECT 'Posting', COUNT(*) FROM posting
UNION ALL
SELECT 'Posting Images', COUNT(*) FROM posting_images
UNION ALL
SELECT 'Comment', COUNT(*) FROM comment
UNION ALL
SELECT 'Favorite Posts', COUNT(*) FROM favorite_posts
UNION ALL
SELECT 'Orders', COUNT(*) FROM orders
UNION ALL
SELECT 'Transaction Record', COUNT(*) FROM transaction_record
UNION ALL
SELECT 'Review', COUNT(*) FROM review
UNION ALL
SELECT 'Message', COUNT(*) FROM message
UNION ALL
SELECT 'Report', COUNT(*) FROM report;
```

---

## 注意事項

### 1. 執行順序

假資料生成必須按照以下順序執行：
1. 基礎資料表（department, class, course）
2. 使用者表（user）
3. 商品相關表（posting, posting_images）
4. 互動相關表（comment, favorite_posts）
5. 交易相關表（orders, transaction_record, review）
6. 通訊相關表（message）
7. 管理相關表（report）

這是因為外鍵約束的存在，必須先建立被參考的表。

### 2. 資料一致性

- 訂單只會為狀態為 `sold` 的刊登生成
- 評價只會為狀態為 `completed` 的訂單生成
- 收藏只會為狀態為 `listed` 的刊登生成
- 確保買家和賣家不是同一人
- 確保發送者和接收者不是同一人

### 3. 效能考量

- 大量資料生成可能需要幾分鐘時間
- 建議在測試環境中執行
- 如果資料量很大，可以分批執行

### 4. 密碼雜湊

生成的假資料中，使用者密碼雜湊是模擬的，不能直接用於登入。如需測試登入功能，請：
1. 使用 `supabase/create_admin.sql` 或 `supabase/create_admin_quick.sql` 建立真實的管理員帳號
2. 透過註冊功能建立真實使用者帳號

### 5. 圖片 URL

生成的假資料中，圖片 URL 使用 placeholder 服務（`https://picsum.photos/...`）。實際使用時應：
1. 使用 Supabase Storage 上傳真實圖片
2. 取得真實的圖片 URL
3. 更新 `posting_images` 表中的 `image_url`

### 6. 資料清理

如果需要重新生成假資料：
- 使用 `supabase/cleanup.sql` 刪除所有資料（包括管理員）
- 使用 `supabase/cleanup_safe.sql` 只刪除使用者生成的資料（保留管理員、科系、分類、課程）

---

## 資料統計

執行完成後，預設會生成以下數量的資料：

| 表名 | 預設數量 | 說明 |
|------|---------|------|
| Department | 20 | 科系 |
| Class | 8 | 分類 |
| Course | 20 | 課程 |
| User | 1000 | 使用者 |
| Posting | 12000 | 刊登 |
| Posting Images | ~24000 | 刊登圖片（每個刊登 1-3 張） |
| Comment | 5000 | 留言 |
| Favorite Posts | 8000 | 收藏 |
| Orders | 3000 | 訂單 |
| Transaction Record | 5000 | 交易紀錄 |
| Review | 2000 | 評價 |
| Message | 3000 | 私訊 |
| Report | 200 | 舉報 |

**總計**：約 60,000+ 筆資料

---

## 自訂生成參數

如需調整生成數量，請修改 `generate_fake_data.sql` 中對應的迴圈範圍：

```sql
-- 範例：將使用者數量改為 500
FOR i IN 1..500 LOOP  -- 原本是 1000

-- 範例：將刊登數量改為 5000
FOR i IN 1..5000 LOOP  -- 原本是 12000
```

---

## 疑難排解

### 問題 1：外鍵約束錯誤

**原因**：執行順序錯誤或缺少基礎資料

**解決**：
1. 確認基礎資料表（department, class, course）已有資料
2. 確認執行順序正確
3. 檢查外鍵約束是否正確設定

### 問題 2：唯一約束錯誤

**原因**：重複插入唯一值

**解決**：
1. 使用 `ON CONFLICT DO NOTHING` 避免重複插入
2. 或先清理現有資料再重新生成

### 問題 3：執行時間過長

**原因**：資料量太大

**解決**：
1. 減少生成數量
2. 分批執行
3. 在非高峰時段執行

### 問題 4：記憶體不足

**原因**：一次性生成太多資料

**解決**：
1. 減少生成數量
2. 分批執行
3. 增加資料庫記憶體配置（如果可能）

---

## 相關文件

- `supabase/generate_fake_data.sql`：假資料生成 SQL 腳本
- `supabase/seed.sql`：現有的種子資料腳本（包含完整邏輯）
- `supabase/cleanup.sql`：完整清理腳本
- `supabase/cleanup_safe.sql`：安全清理腳本（保留管理員和基礎資料）
- `docs/db_schema.md`：資料庫結構文件

---

## 結語

假資料生成腳本提供了完整的測試資料生成方案，可以快速建立大量測試資料用於開發和演示。請根據實際需求調整生成參數，並注意資料一致性和效能考量。

如有問題，請參考相關文件或聯繫開發團隊。

